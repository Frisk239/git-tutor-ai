generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表（单用户模式）
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关系
  sessions      Session[]
  settings      UserSettings?

  @@map("users")
}

// 用户设置
model UserSettings {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])

  // AI 配置（加密存储）
  aiProvider    String    @default("anthropic")
  aiApiKey      String?
  aiModel       String    @default("claude-sonnet-4-5-20250929")
  aiTemperature Float?    @default(0.7)
  aiMaxTokens   Int?      @default(8192)

  // GitHub 配置（加密存储）
  githubToken   String?
  githubUsername String?

  // 系统设置
  theme         String    @default("light")
  language      String    @default("zh-CN")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("user_settings")
}

// 聊天会话
model Session {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])

  title         String
  model         String
  status        String    @default("active") // active, completed, error

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关系
  messages      Message[]

  @@map("sessions")
}

// 消息
model Message {
  id            String    @id @default(cuid())
  sessionId     String
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role          String    // user, assistant, system, tool
  content       String    @db.Text
  toolCalls     Json?     // 工具调用信息（JSON 数组）
  toolCallId    String?   // 工具调用 ID（role=tool 时）

  createdAt     DateTime  @default(now())

  @@index([sessionId])
  @@map("messages")
}
